---
layout:     post
title:      排查并调优慢SQL
subtitle:   ...
date:       2022-11-22
author:     呆贝斯
header-img: img/post-bg-desk.jpg
catalog: true
tags:
    - 数据库
---
# 开启慢查询日志
执行如下语句看是否启用了慢查询日志，ON为启用，OFF为未启用，默认为OFF。
```
SHOW VARIABLES LIKE '%slow_query_log%';
```
如果没有开启，使用如下两种方式来开启慢查询。
1. 修改配置文件
    修改配置文件 vim /etc/my.cnf，在 [mysqld] 段落在加入如下配置：
    ```
    [mysqld] 
    slow_query_log=1 
    slow_query_log_file=/var/lib/mysql/data/slow.log 
    long_query_time=3 
    log_output=FILE,TABLE
    ```
    需要重启 MySQL 才可以生效，命令为 service mysqld restart。

2. 设置全局变量
    如下打开慢查询日志，设置超时时间为 3 秒，并且将日志记录到文件以及 mysql.show_log 表中。
    ```
    SET GLOBAL slow_query_log = 1;
    SET GLOBAL slow_query_log_file='/var/lib/mysql/data/slow.log';
    SET GLOBAL long_query_time=3;
    SET GLOBAL log_output='FILE,TABLE';
    ```
    想要永久生效得用上面那个配置文件里配置，否则数据库重启后，这些配置失效。

| 参数                  | 含义                                                                    |
|---------------------|-----------------------------------------------------------------------|
| slow_query_log      | 是否启用慢查询日志，ON 为启用，OFF 为未启用，默认为 OFF。开启会影响性能，MySQL 重启会失效。                |
| slow_query_log_file | 指定慢查询日志文件的路径和名字，缺省文件名 host_name-slow.log。                             |
| long_query_time     | 执行时间超过该值才记录到慢查询日志，单位为秒，默认为 10。                                        |
| log_output          | 日志输出位置，默认为 FILE，即保存为文件，若设置为 TABLE，则将日志记录到 mysql.show_log 表中，支持设置多种格式。 |

## 分析慢查询日志
1. 获取慢SQL信息
2. mysqldumpslow
3. pt-query-digest

## Explain执行计划分析慢SQL

## Show Profile 分析慢SQL
Show Profile 也可以分析慢 SQL，比 explain 获取的信息更详细，比如能分析当前会话中语句执行的资源消耗情况，
能分析这条 SQL 整个生命周期的耗时。但没有上面 pt-query-digest 那款慢查询日志分析工具强大，
但 pt-query-digest 是外置的需要单独下载，如果你想用内置的话，能够满足你的需求的话，选择 Show Profile 就行。
1. 如何开启
    默认关闭。开启后，会在后台保存最近 15 次的运行结果，然后通过 Show Profile 命令查看结果。
    ```
    -- 开启
    SET profiling = ON;
    -- 查看
    SHOW VARIABLES LIKE 'profiling%';
    ```
2. SHOW profiles查看SQL的耗时

3. SQL整个生命周期的耗时
通过 Query_ID 可以得到具体 SQL 从连接——服务——引擎——存储四层结构完整生命周期的耗时
```
SHOW profile CPU, BLOCK IO FOR QUERY 4;
```
4. 危险状态
